<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TextToJson.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DETonomics</a> &gt; <a href="index.source.html" class="el_package">com.detonomics.budgettuner.backend.budgetingestion</a> &gt; <span class="el_source">TextToJson.java</span></div><h1>TextToJson.java</h1><pre class="source lang-java linenums">package com.detonomics.budgettuner.backend.budgetingestion;

import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;

import com.google.genai.Client;
import com.google.genai.types.Content;
import com.google.genai.types.GenerateContentConfig;
import com.google.genai.types.GenerateContentResponse;
import com.google.genai.types.Part;

<span class="nc" id="L14">public class TextToJson {</span>

  private static final String PROMPT1 = &quot;&quot;&quot;
**ROLE**
You are a budget data-extraction agent. You read unstructured text in Greek or English and return valid JSON only, following the schema below. No prose.

**GOAL**
Extract clean numeric euro values from budget documents, reconstruct hierarchical data based on codes, apply consistency checks, and work across different countries/table formats.

**EXTRACTION RULES**
-Return JSON only. No comments, no preface.
-All amounts as numbers in euros, no symbols, no thousand separators, decimals only if present. Example: &quot;1.304.827.000.000&quot; → 1304827000000.
-Field language: Greek as defined in the schema. Category/Ministry names exactly as in source.
-If a field is missing, set null and record the reason in metadata.missing_fields.
-Normalize separators: remove thousand dots/commas, treat comma as decimal. Ignore €, EUR.
-Hierarchy Reconstruction: For revenue analysis, reconstruct the hierarchy based on classification codes. A code is a child of the longest preceding code that is a prefix of it (e.g., 111 is a child of 11).
-Compute derived fields and verify equalities. If they do not match, populate checks with deltas.
-For tables, preserve source order.
-If multiple versions or years appear, take the most recent or the one explicitly stated.
-Do not alter capitalization/accents in source category titles.

**OUTPUT JSON SCHEMA**

{
  &quot;metadata&quot;: {
    &quot;sourceTitle&quot;: null,
    &quot;sourceDate&quot;: null,
    &quot;budgetYear&quot;: null,
    &quot;currency&quot;: &quot;EUR&quot;,
    &quot;locale&quot;: &quot;Greece&quot;,
    &quot;missingFields&quot;: [],
  },
  &quot;budgetSummary&quot;: {
    &quot;totalRevenue&quot;: 0,
    &quot;totalExpenses&quot;: 0,
    &quot;stateBudgetBalance&quot;: 0,
    &quot;coverageWwithCashReserves&quot;: 0
  },
  &quot;revenueAnalysis&quot;: [
    {
      &quot;code&quot;: &quot;string&quot;,
      &quot;name&quot;: &quot;string&quot;,
      &quot;amount&quot;: 0,
      &quot;children&quot;: []
    }
  ],
  &quot;expenseAnalysis&quot;: [
    { &quot;name&quot;: &quot;string&quot;, &quot;amount&quot;: 0, &quot;code&quot;: null }
  ],
  &quot;distributionByMinistry&quot;: [
    {
      &quot;code&quot;: &quot;string&quot;,
      &quot;ministryBody&quot;: &quot;string&quot;,
      &quot;totalFromMajorCategories&quot;: [
        { &quot;code&quot;: &quot;string|number&quot;, &quot;name&quot;: &quot;string&quot;, &quot;amount&quot;: 0 }
      ],
      &quot;regularBudget&quot;: 0,
      &quot;publicInvestmentBudget&quot;: 0,
      &quot;total&quot;: 0
    }
  ],
  &quot;checks&quot;: {
    &quot;sumOfRevenueEqualsTotal&quot;: { &quot;expected&quot;: 0, &quot;calculated&quot;: 0, &quot;ok&quot;: true, &quot;difference&quot;: 0 },
    &quot;sumOfExpensesEqualsTotal&quot;: { &quot;expected&quot;: 0, &quot;calculated&quot;: 0, &quot;ok&quot;: true, &quot;difference&quot;: 0 },
    &quot;balanceEqualsRevenueMinusExpenses&quot;: { &quot;expected&quot;: 0, &quot;calculated&quot;: 0, &quot;ok&quot;: true, &quot;difference&quot;: 0 }
  }
}

**EXTRACTION STEPS**
1.Locate the summary section and extract the four main budget values.
2.Scan for both summary and detailed revenue tables. Build a nested array for ανάλυση_εσόδων, identifying parent-child relationships from the codes.
3.Locate the expense table by economic category (titled &quot;ΠΙΣΤΩΣΕΙΣ ΚΑΤΑ ΜΕΙΖΟΝΑ ΚΑΤΗΓΟΡΙΑ ΔΑΠΑΝΗΣ&quot;). Extract each category into the ανάλυση_εξόδων array as a flat list.
4.Locate the three expense tables broken down by Ministry/Agency (titled &quot;ΠΙΣΤΩΣΕΙΣ ΣΥΝΟΛΙΚΑ ΚΑΤΑ ΦΟΡΕΑ&quot;). These correspond to the Total State Budget, the Regular Budget, and the Public Investment Budget.
5.Consolidate the ministry data. For each ministry, create one object in the κατανομή_ανά_υπουργείο array. Populate the σύνολο, τακτικός_προϋπολογισμός, and προϋπολογισμός_δημοσίων_επενδύσεων fields by matching the ministry's name and code across the three respective tables.
6.Convert all monetary values to numeric euros.
7.Fill metadata with any available title/date/year details.
8.Compute checks; if any fail, set ok: false and include the delta.

**NUMBER RULES**
Remove thousand separators. Replace decimal comma with a dot.
Example: &quot;1.304.827.000.000 €&quot; → 1304827000000
Example: &quot;85.000,50&quot; → 85000.5


**EXAMPLE OUTPUT FOR &quot;revenueAnalysis&quot; (Hierarchical)**

{
  &quot;revenueAnalysis&quot;: [
    {
      &quot;code&quot;: &quot;11&quot;,
      &quot;name&quot;: &quot;Φόροι&quot;,
      &quot;amount&quot;: 62055000000,
      &quot;children&quot;: [
        {
          &quot;code&quot;: &quot;111&quot;,
          &quot;name&quot;: &quot;Φόροι επί αγαθών και υπηρεσιών&quot;,
          &quot;amount&quot;: 33667000000,
          &quot;children&quot;: [
            {
              &quot;code&quot;: &quot;11101&quot;,
              &quot;name&quot;: &quot;Φόροι προστιθέμενης αξίας που εισπράττονται μέσω Δ.Ο.Υ&quot;,
              &quot;amount&quot;: 14635000000,
              &quot;children&quot;: [
                {
                  &quot;code&quot;: &quot;1110103&quot;,
                  &quot;name&quot;: &quot;ΦΠΑ από ηλεκτρονικό εμπόριο&quot;,
                  &quot;amount&quot;: 250000000,
                  &quot;children&quot;: []
                }
              ]
            }
          ]
        }
      ]
    },
    {
      &quot;code&quot;: &quot;12&quot;,
      &quot;name&quot;: &quot;Κοινωνικές εισφορές&quot;,
      &quot;amount&quot;: 60000000,
      &quot;children&quot;: []
    }
  ]
}
**EXAMPLE 2: &quot;expenseAnalysis&quot;**
{
  &quot;expenseAnalysis&quot;: [
    { &quot;code&quot;: &quot;21&quot;, &quot;name&quot;: &quot;Παροχές σε εργαζομένους&quot;, &quot;amount&quot;: 14889199000 },
    { &quot;code&quot;: &quot;22&quot;, &quot;name&quot;: &quot;Κοινωνικές παροχές&quot;, &quot;amount&quot;: 425136000 },
    { &quot;code&quot;: &quot;23&quot;, &quot;name&quot;: &quot;Μεταβιβάσεις&quot;, &quot;amount&quot;: 34741365000 },
    { &quot;code&quot;: &quot;26&quot;, &quot;name&quot;: &quot;Τόκοι&quot;, &quot;amount&quot;: 7701101000 }
  ]
}

**EXAMPLE OUTPUT FOR &quot;distributionByMinistry&quot;**

{
  &quot;distributionByMinistry&quot;: [
    {
      &quot;code&quot;: &quot;1001&quot;,
      &quot;ministryBody&quot;: &quot;ΠΡΟΕΔΡΙΑ ΤΗΣ ΔΗΜΟΚΡΑΤΙΑΣ&quot;,
      &quot;totalFromMajorCategories&quot;: [
        { &quot;code&quot;: &quot;21&quot;, &quot;name&quot;: &quot;Παροχές σε εργαζομένους&quot;, &quot;amount&quot;: 3532000 },
        { &quot;code&quot;: &quot;24&quot;, &quot;name&quot;: &quot;Αγορές αγαθών και υπηρεσιών&quot;, &quot;amount&quot;: 850000 }
      ],
      &quot;regularBudget&quot;: 4638000,
      &quot;publicInvestment_budget&quot;: 0,
      &quot;total&quot;: 4638000
    }
  ]
}
  
Return only the JSON defined by the schema. No extra information.
&quot;&quot;&quot;;
 public static void textFileToJson(Path inTxt, Path outJson) throws Exception {
<span class="nc" id="L168">    String apiKey = System.getenv(&quot;GEMINI_API_KEY&quot;);</span>

<span class="nc bnc" id="L170" title="All 4 branches missed.">    if (apiKey == null || apiKey.isBlank()) {</span>
<span class="nc" id="L171">            throw new IllegalArgumentException(&quot;Error: GEMINI_API_KEY environment variable is not set.&quot;);</span>
     }

<span class="nc" id="L174">    Client client = Client.builder()</span>
<span class="nc" id="L175">            .apiKey(apiKey)</span>
<span class="nc" id="L176">            .build();</span>

<span class="nc" id="L178">    Content systemInstruction = Content.fromParts(Part.fromText(PROMPT1));</span>

<span class="nc" id="L180">    GenerateContentConfig cfg = GenerateContentConfig.builder()</span>
<span class="nc" id="L181">            .systemInstruction(systemInstruction)</span>
<span class="nc" id="L182">            .build();</span>
 
<span class="nc" id="L184">    String raw = Files.readString(inTxt, StandardCharsets.UTF_8);</span>
    


<span class="nc" id="L188">    GenerateContentResponse res = client.models.generateContent(</span>
        &quot;gemini-2.5-flash&quot;,
        raw,
        cfg
    );

<span class="nc" id="L194">    String text = res.text();</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">    if (text == null) {</span>
<span class="nc" id="L197">        System.err.println(&quot;Model returned null text. Check API key, model name, or input size.&quot;);</span>
<span class="nc" id="L198">        System.err.println(&quot;Raw response: &quot; + res);</span>
<span class="nc" id="L199">        return;</span>
    }

<span class="nc" id="L202">    String json = text.trim()</span>
<span class="nc" id="L203">        .replaceAll(&quot;(?s)^```(?:json)?\\s*|\\s*```$&quot;, &quot;&quot;); // remove markdown fences</span>

<span class="nc" id="L205">    Files.writeString(outJson, json, StandardCharsets.UTF_8,</span>
        StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);

<span class="nc" id="L208">    System.out.println(&quot;Saved to &quot; + outJson.toAbsolutePath());</span>

<span class="nc" id="L210">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>